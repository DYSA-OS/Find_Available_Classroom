<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Display a map on a webpage</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 160px; /* 검색 폼을 위한 공간 확보 */
            bottom: 0;
            width: 100%;
        }

        .mapboxgl-popup {
            max-width: 450px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
    </style>
    {% load static %}
</head>

<body>
<div class="container mt-4" style="position: absolute; top: 10px; width: 100%; z-index: 1;">
    <form id="time-form" class="form-inline mb-2">
        <div class="form-group mb-2">
            <label for="datetime" class="sr-only">Select a date and time:</label>
            <input type="datetime-local" class="form-control" id="datetime" name="datetime" required>
        </div>
        <button type="submit" class="btn btn-primary mb-2 ml-2">Search</button>
    </form>
    <form id="room-check-form" class="form-inline mb-2">
        <div class="form-group mb-2">
            <label for="building_name" class="sr-only">Select Building:</label>
            <select class="form-control" id="building_name" name="building_name" required>
                {% for building in buildings %}
                <option value="{{ building.name }}">{{ building.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group mb-2">
            <label for="room_number" class="sr-only">Enter Room Number:</label>
            <input type="text" class="form-control" id="room_number" name="room_number" placeholder="Enter Room Number" required>
        </div>
        <button type="submit" class="btn btn-primary mb-2 ml-2">Check Room</button>
    </form>
    <div id="room-status"></div>
</div>

<div id="map"></div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Room Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Room details will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
    document.getElementById('time-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const datetime = document.getElementById('datetime').value;
        const url = `/class/map/?datetime=${encodeURIComponent(datetime)}`;
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // Update the map with new data
                map.getSource('places').setData(data);
            })
            .catch(error => console.error('Error:', error));
    });

    document.getElementById('room-check-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const datetime = document.getElementById('datetime').value;
        const buildingName = document.getElementById('building_name').value;
        const roomNumber = document.getElementById('room_number').value;
        const url = `/class/check_room/?datetime=${encodeURIComponent(datetime)}&building_name=${encodeURIComponent(buildingName)}&room_number=${encodeURIComponent(roomNumber)}`;
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                const roomStatusDiv = document.getElementById('room-status');
                if (data.available) {
                    roomStatusDiv.innerHTML = `현재 ${buildingName} 건물의 ${roomNumber} 강의실은 사용 가능합니다.`;
                } else {
                    const lectureDetails = data.lectures.map(lecture => {
                        return `
                            <li class="list-group-item">
                                <p><strong>Subject:</strong> ${lecture.subject}</p>
                                <p><strong>Professor:</strong> ${lecture.professor}</p>
                                <p><strong>Lecture Type:</strong> ${lecture.lecture_type}</p>
                                <p><strong>Day:</strong> ${lecture.day}</p>
                                <p><strong>Start Time:</strong> ${lecture.start_time}</p>
                                <p><strong>End Time:</strong> ${lecture.end_time}</p>
                            </li>
                        `;
                    }).join('');
                    roomStatusDiv.innerHTML = `
                        <p>현재 ${buildingName} 건물의 ${roomNumber} 강의실에서 진행 중인 수업:</p>
                        <ul class="list-group">${lectureDetails}</ul>
                    `;
                }
            })
            .catch(error => console.error('Error:', error));
    });

    mapboxgl.accessToken = 'pk.eyJ1Ijoic29sYWNvbGEiLCJhIjoiY2x3ajhkdTM5MDA1MTJpcDhscW9tNWdmOSJ9.0NoHkd4AGLDhM_2YKMC13w';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/riverallzero/clae38gsh000714pnzx14v02h', // style URL
        center: [127.130845, 35.849160], // 학교 경도, 위도
        zoom: 16,
        projection: 'globe',
        pitch: 45,
        bearing: -20,
        antialias: true
    });

    map.on('load', () => {
        // Add image icons to the map
        map.loadImage("{% static 'images/location.png' %}", (error, image) => {
            if (error) throw error;
            map.addImage('green-marker', image);
        });

        const geojson = JSON.parse('{{ geojson|escapejs }}');

        map.addSource('places', {
            'type': 'geojson',
            'data': geojson
        });

        // Add a layer showing the places for available rooms with custom marker
        map.addLayer({
            'id': 'available-places',
            'type': 'symbol',
            'source': 'places',
            'filter': ['>', ['get', 'available_count'], 0],
            'layout': {
                'icon-image': 'green-marker',
                'icon-size': 0.05,  // Adjust the size here (0.05 = 5%)
                'icon-allow-overlap': true
            }
        });

        // Add labels to show the number of available rooms
        map.addLayer({
            'id': 'available-labels',
            'type': 'symbol',
            'source': 'places',
            'filter': ['>', ['get', 'available_count'], 0],
            'layout': {
                'text-field': ['concat', ['get', 'available_count'], ' available'],
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-offset': [0, 1.5],
                'text-anchor': 'top'
            },
            'paint': {
                'text-color': '#000000'
            }
        });

        // Create a popup, but don't add it to the map yet.
        const popup = new mapboxgl.Popup({
            closeButton: true,
            closeOnClick: true
        });

        map.on('click', 'available-places', (e) => {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            // Copy coordinates array.
            const coordinates = e.features[0].geometry.coordinates.slice();
            const description = e.features[0].properties.description;
            const available_rooms = e.features[0].properties.available_rooms;
            const occupied_rooms = e.features[0].properties.occupied_rooms;
            const building_name = e.features[0].properties.name;  // 빌딩 이름

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates
            // based on the feature found.
            popup.setLngLat(coordinates).setHTML(`
                ${description}<br>
                <button class="btn btn-danger" onclick='showDetails(${JSON.stringify(occupied_rooms || [])}, "occupied", "${building_name}")'>Occupied Rooms Details</button>
                <button class="btn btn-success" onclick='showDetails(${JSON.stringify(available_rooms || [])}, "available", "${building_name}")'>Available Rooms</button>
            `).addTo(map);
        });

        window.showDetails = function(rooms, status, building_name) {
            if (!rooms) {
                console.error('Rooms array is undefined');
                return;
            }

            rooms = typeof rooms === 'string' ? JSON.parse(rooms) : rooms;

            if (!Array.isArray(rooms)) {
                console.error('Rooms is not an array:', rooms);
                return;
            }

            let roomList = rooms.map(room => {
                return status === 'occupied'
                    ? `<li class="list-group-item" onclick="showRoomDetails('${room}', '${building_name}')">${room}</li>`
                    : `<li class="list-group-item">${room}</li>`;
            }).join('');

            let roomDetails = `Rooms (${status}):<ul class="list-group">${roomList}</ul>`;
            document.getElementById('modalBody').innerHTML = roomDetails;
            $('#detailsModal').modal('show');
        };

        window.showRoomDetails = function(room, building_name) {
            console.log('Requesting details for room:', room); // 로그 출력
            fetch(`/class/get_room_details/?room_number=${room}&building_name=${building_name}`)  // URL을 올바르게 설정
                .then(response => response.json())
                .then(data => {
                    console.log('Received data:', data); // 로그 출력
                    let lectureDetails = data.lectures.map(lecture => {
                        return `
                            <li class="list-group-item">
                                <p><strong>Subject:</strong> ${lecture.subject}</p>
                                <p><strong>Professor:</strong> ${lecture.professor}</p>
                                <p><strong>Lecture Type:</strong> ${lecture.lecture_type}</p>
                                <p><strong>Day:</strong> ${lecture.day}</p>
                                <p><strong>Start Time:</strong> ${lecture.start_time}</p>
                                <p><strong>End Time:</strong> ${lecture.end_time}</p>
                            </li>
                        `;
                    }).join('');
                    document.getElementById('modalBody').innerHTML = lectureDetails;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('modalBody').innerHTML = `<p>Error fetching room details</p>`;
                });
        };
    });
</script>
</body>
</html>
