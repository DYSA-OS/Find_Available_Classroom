<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Display a map on a webpage</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .mapboxgl-popup {
            max-width: 450px;
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
    </style>
    {% load static %}
</head>

<body>
<div id="map"></div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Room Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Room details will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic29sYWNvbGEiLCJhIjoiY2x3ajhkdTM5MDA1MTJpcDhscW9tNWdmOSJ9.0NoHkd4AGLDhM_2YKMC13w';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/riverallzero/clae38gsh000714pnzx14v02h', // style URL
        center: [127.130845, 35.849160], // 학교 경도, 위도
        zoom: 16,
        projection: 'globe',
        pitch: 45,
        bearing: -20,
        antialias: true
    });

    map.on('load', () => {
        // Add image icons to the map
        map.loadImage("{% static 'images/location.png' %}", (error, image) => {
            if (error) throw error;
            map.addImage('green-marker', image);
        });

        const geojson = JSON.parse('{{ geojson|escapejs }}');

        map.addSource('places', {
            'type': 'geojson',
            'data': geojson
        });

        // Add a layer showing the places for available rooms with custom marker
        map.addLayer({
            'id': 'available-places',
            'type': 'symbol',
            'source': 'places',
            'filter': ['>', ['get', 'available_count'], 0],
            'layout': {
                'icon-image': 'green-marker',
                'icon-size': 0.05,  // Adjust the size here (0.05 = 5%)
                'icon-allow-overlap': true
            }
        });

        // Add labels to show the number of available rooms
        map.addLayer({
            'id': 'available-labels',
            'type': 'symbol',
            'source': 'places',
            'filter': ['>', ['get', 'available_count'], 0],
            'layout': {
                'text-field': ['concat', ['get', 'available_count'], ' available'],
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-offset': [0, 1.5],
                'text-anchor': 'top'
            },
            'paint': {
                'text-color': '#000000'
            }
        });

        // Create a popup, but don't add it to the map yet.
        const popup = new mapboxgl.Popup({
            closeButton: true,
            closeOnClick: true
        });

        map.on('click', 'available-places', (e) => {
            // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';

            // Copy coordinates array.
            const coordinates = e.features[0].geometry.coordinates.slice();
            const description = e.features[0].properties.description;
            const available_rooms = e.features[0].properties.available_rooms;
            const occupied_rooms = e.features[0].properties.occupied_rooms;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates
            // based on the feature found.
            popup.setLngLat(coordinates).setHTML(`
                ${description}<br>
                <button class="btn btn-danger" onclick='showDetails(${JSON.stringify(occupied_rooms || [])}, "occupied")'>Occupied Rooms Details</button>
                <button class="btn btn-success" onclick='showDetails(${JSON.stringify(available_rooms || [])}, "available")'>Available Rooms</button>
            `).addTo(map);
        });

        window.showDetails = function(rooms, status) {
            if (!rooms) {
                console.error('Rooms array is undefined');
                return;
            }

            rooms = typeof rooms === 'string' ? JSON.parse(rooms) : rooms;

            if (!Array.isArray(rooms)) {
                console.error('Rooms is not an array:', rooms);
                return;
            }

            let roomList = rooms.map(room => {
                return `<li class="list-group-item">${room}</li>`;
            }).join('');

            let roomDetails = `Rooms (${status}):<ul class="list-group">${roomList}</ul>`;
            document.getElementById('modalBody').innerHTML = roomDetails;
            $('#detailsModal').modal('show');
        };
    });
</script>
</body>
</html>
